import json
import sys
import os
import numpy as np
import base64
import tempfile
from http.server import BaseHTTPRequestHandler

# Add parent directory to path so we can import our model modules
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Import model modules (these will be available after running convert_notebooks.py)
try:
    from models.malware_detection.model import Model as MalwareModel
    from models.malware_detection.preprocessor import Preprocessor as MalwarePreprocessor
    
    MODELS_AVAILABLE = True
except ImportError:
    MODELS_AVAILABLE = False

# Load model (this will be executed once when the serverless function is initialized)
malware_model = None
if MODELS_AVAILABLE:
    malware_model = MalwareModel()
    model_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 
                             'saved_models', 'malware_model.h5')
    if os.path.exists(model_path):
        malware_model.load(model_path)

class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        # Check if model is available
        if not MODELS_AVAILABLE or malware_model is None:
            self.send_response(503)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            response = {'error': 'Malware detection model not available'}
            self.wfile.write(json.dumps(response).encode())
            return
        
        # Get request body
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        
        try:
            data = json.loads(post_data)
            
            # Process the data based on what's provided
            preprocessor = MalwarePreprocessor()
            
            # Check if file data is provided (base64 encoded)
            if 'file_data' in data:
                # Create a temporary file
                with tempfile.NamedTemporaryFile(delete=False) as temp_file:
                    # Decode base64 data and write to file
                    file_data = base64.b64decode(data['file_data'])
                    temp_file.write(file_data)
                    temp_file_path = temp_file.name
                
                try:
                    # Extract features from file
                    features = preprocessor.preprocess_file(temp_file_path)
                finally:
                    # Clean up the temporary file
                    if os.path.exists(temp_file_path):
                        os.remove(temp_file_path)
            
            # If system metrics are provided directly
            elif 'metrics' in data:
                features = preprocessor.preprocess(data['metrics'])
            
            else:
                self.send_response(400)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                response = {'error': 'Either file_data or metrics must be provided'}
                self.wfile.write(json.dumps(response).encode())
                return
            
            # Make prediction
            prediction = malware_model.predict(features)
            probability = float(np.max(prediction))
            is_malware = bool(np.argmax(prediction))
            
            # Send response
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            
            response = {
                'is_malware': is_malware,
                'confidence': probability,
                'status': 'success'
            }
            
            self.wfile.write(json.dumps(response).encode())
            
        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            response = {'error': str(e)}
            self.wfile.write(json.dumps(response).encode())
    
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        
        response = {
            'service': 'malware detection',
            'status': 'available' if MODELS_AVAILABLE and malware_model is not None else 'unavailable',
            'usage': 'Send a POST request with JSON body containing either "file_data" (base64 encoded) or "metrics" fields'
        }
        
        self.wfile.write(json.dumps(response).encode())
